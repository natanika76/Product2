<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tasketl3b - Editable Table</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
            margin: 20px;
        }
        h1 {
            text-align: center;
            color: #007BFF;
        }
        #roleInfo, #logoutContainer {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: center;
        }
        th {
            background-color: #007BFF;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        input[type="number"], input[type="text"], input[type="datetime-local"] {
            width: 90%;
            padding: 8px;
            box-sizing: border-box;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            background-color: #007BFF;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            margin: 2px;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #addForm {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 20px auto;
            border-radius: 8px;
        }
        #addForm h3 {
            margin-top: 0;
            color: #007BFF;
        }
        #addForm label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }
        #addForm input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #addForm button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            border: none;
            color: #fff;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        #addForm button:hover {
            background-color: #218838;
        }
        userInfo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        #roleInfo, #userEmail, #logoutContainer {
            font-size: 16px;
            margin: 0;
            color: #666;
            padding: 5px 10px;
            background: #f0f4f8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
<h1>Tasketl3b</h1>
<div id="userInfo">
    <div id="roleInfo"></div>
    <div id="userEmail"></div>
    <div id="logoutContainer">
        <button class="btn" onclick="logout3()">Logout</button>
    </div>
</div>
<table id="taskTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>ЕИ</th>
        <th>StatusTime</th>
        <th>Длительность</th>
        <th>Статус</th>
        <th>Группа</th>
        <th>Назначение</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>
<div id="addForm" style="display:none;">
    <h3>Add New Task</h3>
    <label>ЕИ:
        <input type="number" id="newEi" step="any">
    </label>
    <label>StatusTime:
        <input type="datetime-local" id="newStatusTime">
    </label>
    <label>Длительность:
        <input type="number" id="newDuration" step="any">
    </label>
    <label>Статус:
        <input type="text" id="newStatus">
    </label>
    <label>Группа:
        <input type="text" id="newGroupName">
    </label>
    <label>Назначение:
        <input type="number" id="newAssignment">
    </label>
    <button onclick="addTask()">Add Task</button>
</div>
<script>
    let userRole = '';

    function fetchUserRole() {
        fetch('/user-role')
            .then(response => response.text())
            .then(role => {
                userRole = role;
                document.getElementById('roleInfo').innerText = 'Your role: ' + role;
                if (role === 'ADMIN') {
                    document.getElementById('addForm').style.display = 'block';
                }
                fetchTasks();
            });
    }

    function fetchTasks() {
        fetch('/api/tasketl3b')
            .then(response => response.json())
            .then(tasks => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                tasks.forEach(task => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><span class="id">${task.id}</span></td>` +
                                   `<td><span class="ei">${task.ei || ''}</span></td>` +
                                   `<td><span class="statusTime">${task.statusTime ? task.statusTime.replace('T', ' ') : ''}</span></td>` +
                                   `<td><span class="duration">${task.duration}</span></td>` +
                                   `<td><span class="status">${task.status || ''}</span></td>` +
                                   `<td><span class="groupName">${task.groupName || ''}</span></td>` +
                                   `<td><span class="assignment">${task.assignment}</span></td>`;
                    if (userRole === 'ADMIN') {
                        tr.innerHTML += `<td>
                            <button class="btn" onclick="editTask(${task.id}, this)">Edit</button>
                            <button class="btn" onclick="deleteTask(${task.id})">Delete</button>
                        </td>`;
                    } else {
                        tr.innerHTML += `<td>
                            <button class="btn" onclick="viewTask(${task.id})">View</button>
                        </td>`;
                    }
                    tbody.appendChild(tr);
                });
            });
    }

    function editTask(id, btn) {
        const tr = btn.parentElement.parentElement;
        // Теперь ожидаем 7 span-элементов (включая ID)
        const cells = tr.querySelectorAll('span');

        if (cells.length < 7) {
            alert("Ошибка: не все поля выбраны для редактирования.");
            return;
        }

        // Если ID редактировать не требуется, изменяем поля со второго по седьмой элемент
        // Изменяем поле "ЕИ" - второй span
        cells[1].innerHTML = `<input type="number" step="any" value="${cells[1].innerText}">`;
        // Поле "StatusTime" - третий span
        cells[2].innerHTML = `<input type="datetime-local" value="${cells[2].innerText.replace(' ', 'T')}">`;
        // Поле "Длительность" - четвёртый span
        cells[3].innerHTML = `<input type="number" step="any" value="${cells[3].innerText}">`;
        // Поле "Статус" - пятый span
        cells[4].innerHTML = `<input type="text" value="${cells[4].innerText}">`;
        // Поле "Группа" - шестой span
        cells[5].innerHTML = `<input type="text" value="${cells[5].innerText}">`;
        // Поле "Назначение" - седьмой span
        cells[6].innerHTML = `<input type="number" value="${cells[6].innerText}">`;

        btn.innerText = 'Save';
        btn.onclick = function() { saveTask(id, tr); };
    }

    function saveTask(id, tr) {
        const inputs = tr.querySelectorAll('input');
        const updatedTask = {
            ei: parseFloat(inputs[0].value),
            statusTime: inputs[1].value,
            duration: parseFloat(inputs[2].value),
            status: inputs[3].value,
            groupName: inputs[4].value,
            assignment: parseInt(inputs[5].value)
        };
        fetch('/api/tasketl3b/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedTask)
        }).then(response => {
            if (response.ok) {
                fetchTasks();
            } else {
                alert('Update failed');
            }
        });
    }

    function deleteTask(id) {
        fetch('/api/tasketl3b/' + id, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    fetchTasks();
                } else {
                    alert('Delete failed');
                }
            });
    }

    function addTask() {
        const newTask = {
            ei: parseFloat(document.getElementById('newEi').value),
            statusTime: document.getElementById('newStatusTime').value,
            duration: parseFloat(document.getElementById('newDuration').value),
            status: document.getElementById('newStatus').value,
            groupName: document.getElementById('newGroupName').value,
            assignment: parseInt(document.getElementById('newAssignment').value)
        };
        fetch('/api/tasketl3b', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newTask)
        }).then(response => {
            if (response.ok) {
                fetchTasks();
            } else {
                alert('Add failed');
            }
        });
    }

    function viewTask(id) {
        alert("Viewing details for task ID: " + id);
    }
    function logout2() {
        window.location.href='/logout-basic';
    }
    function logout3() {
        window.location.href='/logout';
    }
    function logout() {
        fetch('/logout', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    // Перенаправление на страницу логина или главную
                    window.location.href = '/login';
                } else {
                    alert('Logout failed');
                }
            });
    }

    document.addEventListener('DOMContentLoaded', fetchUserRole);
    function fetchUserInfo() {
        fetch('/api/user-info')
            .then(response=>response.json())
            .then(data=>{
                document.getElementById("userEmail").innerText='Email: '+data.email;
            });
        }
        document.addEventListener('DOMContentLoaded', fetchUserInfo);
</script>
</body>
</html>
